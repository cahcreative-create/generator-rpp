<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RPP Generator Berbasis AI (by Bams)</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase Authentication -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
      getAuth, 
      signInAnonymously, 
      signInWithCustomToken, 
      onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- KONFIGURASI FIREBASE (ISI DENGAN DATA FIREBASE ANDA) ---
    const firebaseConfig = {
      apiKey: "ISI_DENGAN_API_KEY_FIREBASE_ANDA",
      authDomain: "ISI_DENGAN_AUTH_DOMAIN",
      projectId: "ISI_DENGAN_PROJECT_ID",
      storageBucket: "ISI_DENGAN_STORAGE_BUCKET",
      messagingSenderId: "ISI_DENGAN_SENDER_ID",
      appId: "ISI_DENGAN_APP_ID"
    };

    // --- INISIALISASI FIREBASE ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    window.app = app;
    window.auth = auth;
    window.db = db;
    window.isFirebaseReady = false;

    const btnText = document.getElementById('btn-text');
    const generateBtn = document.getElementById('generate-btn');
    const errorMessage = document.getElementById('error-message');

    function displayError(message) {
      errorMessage.textContent = message;
      errorMessage.classList.remove('hidden');
    }

    // --- LOGIN FIREBASE (CUSTOM TOKEN / ANONIM) ---
    const customToken = window.__initial_auth_token || null;
    const signIn = customToken 
      ? signInWithCustomToken(auth, customToken).catch(() => signInAnonymously(auth))
      : signInAnonymously(auth);

    signIn
      .then((userCredential) => {
        console.log("Login Firebase berhasil:", userCredential.user.uid);
        window.isFirebaseReady = true;
        btnText.textContent = 'Buat RPP by Bams';
        generateBtn.disabled = false;
      })
      .catch((error) => {
        console.error("Gagal otentikasi Firebase:", error);
        window.isFirebaseReady = false;
        btnText.textContent = 'Gagal Otentikasi';
        displayError("Gagal menghubungkan ke Firebase. Periksa konfigurasi atau koneksi internet.");
      });

    onAuthStateChanged(auth, (user) => {
      if (user) {
        console.log("Pengguna aktif:", user.uid);
        window.userId = user.uid;
      } else {
        console.log("Tidak ada pengguna aktif.");
        window.userId = null;
      }
    });

    window.addEventListener('load', () => {
      if (!auth) {
        displayError("Firebase gagal dimuat. Periksa koneksi atau versi SDK.");
        btnText.textContent = 'Gagal Otentikasi';
        generateBtn.disabled = true;
      }
    });
  </script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
    body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
    #rpp-output::-webkit-scrollbar { width: 8px; }
    #rpp-output::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
  </style>
</head>

<body class="p-4 md:p-8 min-h-screen">
  <div class="max-w-7xl mx-auto">
    <header class="mb-8 text-center">
      <h1 class="text-3xl font-extrabold text-blue-800 md:text-4xl">RPP Generator Berbasis AI</h1>
      <p class="text-lg text-gray-600 mt-1">Oleh: Bams Collection (Didukung Gemini AI)</p>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Panel Form -->
      <div class="bg-white p-6 rounded-xl shadow-lg lg:col-span-1">
        <h2 class="text-xl font-bold mb-5 text-gray-800 border-b pb-2">Formulir Input RPP</h2>
        <form id="rpp-form" onsubmit="generateRPP(event)" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">1. Mata Pelajaran</label>
            <input id="subject" class="w-full p-3 border rounded-lg" placeholder="Contoh: Matematika" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">2. Kelas/Tingkat</label>
            <input id="grade" class="w-full p-3 border rounded-lg" placeholder="Contoh: Kelas 4 (Fase B)" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">3. Topik/Materi Pokok</label>
            <input id="topic" class="w-full p-3 border rounded-lg" placeholder="Contoh: Penjumlahan sampai 4 angka" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">4. Alokasi Waktu (JP)</label>
            <input id="time_allocation" class="w-full p-3 border rounded-lg" placeholder="Contoh: 2 x 35 menit" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">5. Tujuan Pembelajaran</label>
            <textarea id="objective" rows="3" class="w-full p-3 border rounded-lg" placeholder="Contoh: Siswa dapat mengaplikasikan penjumlahan sampai 4 angka dalam kehidupan sehari-hari." required></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">6. Model Pembelajaran (Opsional)</label>
            <input id="model" class="w-full p-3 border rounded-lg" placeholder="Contoh: PBL, PJBL, atau kosongkan">
          </div>

          <div class="pt-4 space-y-3">
            <button id="generate-btn" type="submit" disabled class="w-full py-3 rounded-lg font-semibold text-white bg-green-600 hover:bg-green-700 transition">
              <span id="btn-text">Memuat Otentikasi...</span>
              <div id="spinner" class="hidden animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div>
            </button>
            <button id="download-btn" type="button" disabled onclick="downloadRPP()" class="w-full py-3 border rounded-lg bg-white hover:bg-gray-50 text-gray-700">
              Unduh Dokumen (.md)
            </button>
          </div>
          <div id="error-message" class="hidden mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg text-sm"></div>
        </form>
      </div>

      <!-- Panel Output -->
      <div class="bg-white p-6 rounded-xl shadow-lg lg:col-span-2">
        <h2 class="text-xl font-bold mb-5 text-gray-800 border-b pb-2">Hasil RPP Generator</h2>
        <div id="loading-indicator" class="hidden text-center p-8">
          <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500 mx-auto mb-3"></div>
          <p class="text-blue-600 font-medium">Sedang menyusun RPP Anda...</p>
          <p class="text-sm text-gray-500 mt-1">Proses ini memakan waktu sekitar 15-30 detik.</p>
        </div>
        <div id="rpp-output" class="text-base text-gray-700 whitespace-pre-wrap leading-relaxed max-h-[80vh] overflow-y-auto">
          <p class="text-gray-500 italic">Isi RPP akan muncul di sini setelah Anda menekan tombol "Buat RPP by Bams".</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Script Utama -->
  <script>
    const API_MODEL = 'gemini-2.5-flash-preview-09-2025';
    const API_URL_BASE = `https://generativelanguage.googleapis.com/v1beta/models/${API_MODEL}:generateContent?key=`;
    const API_KEY = ""; // masukkan API key Gemini kamu di sini

    const generateBtn = document.getElementById('generate-btn');
    const downloadBtn = document.getElementById('download-btn');
    const rppOutput = document.getElementById('rpp-output');
    const loadingIndicator = document.getElementById('loading-indicator');
    const errorMessage = document.getElementById('error-message');
    const spinner = document.getElementById('spinner');
    const btnText = document.getElementById('btn-text');

    function checkRequiredFields() {
      const fields = ['subject','grade','topic','time_allocation','objective'];
      return fields.every(id => document.getElementById(id).value.trim() !== '');
    }

    async function generateRPP(event) {
      event.preventDefault();
      if (!window.isFirebaseReady) {
        displayError("Firebase belum siap. Tunggu beberapa detik lalu coba lagi.");
        return;
      }
      if (!checkRequiredFields()) {
        displayError("Lengkapi semua kolom wajib sebelum melanjutkan.");
        return;
      }

      generateBtn.disabled = true;
      downloadBtn.disabled = true;
      errorMessage.classList.add('hidden');
      rppOutput.innerHTML = '';
      loadingIndicator.classList.remove('hidden');
      spinner.classList.remove('hidden');
      btnText.textContent = 'Memproses...';

      const subject = subject.value;
      const grade = grade.value;
      const topic = topic.value;
      const timeAllocation = time_allocation.value;
      const objective = objective.value;
      const model = model.value;

      const userQuery = `
        Mata Pelajaran: ${subject}
        Kelas/Tingkat: ${grade}
        Topik: ${topic}
        Alokasi Waktu: ${timeAllocation}
        Tujuan Pembelajaran: ${objective}
        Model Pembelajaran: ${model || 'Tidak ditentukan.'}
      `;

      const payload = {
        contents: [{ parts: [{ text: userQuery }] }],
        systemInstruction: { parts: [{ text: "Buat RPP lengkap dan terstruktur dalam format markdown sesuai Kurikulum Merdeka." }] }
      };

      try {
        const response = await fetch(API_URL_BASE + API_KEY, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const result = await response.json();
        const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Tidak ada hasil dari AI.";
        rppOutput.innerHTML = `<div class='p-4 border rounded-lg bg-gray-50 whitespace-pre-wrap'>${text}</div>`;
        downloadBtn.disabled = false;
      } catch (err) {
        displayError("Gagal memuat hasil. " + err.message);
      }

      loadingIndicator.classList.add('hidden');
      spinner.classList.add('hidden');
      btnText.textContent = 'Buat RPP by Bams';
      generateBtn.disabled = !checkRequiredFields();
    }

    function displayError(msg) {
      errorMessage.textContent = msg;
      errorMessage.classList.remove('hidden');
    }

    function downloadRPP() {
      const subject = document.getElementById('subject').value;
      const topic = document.getElementById('topic').value;
      const content = rppOutput.textContent;
      const blob = new Blob([content], { type: 'text/markdown;charset=utf-8' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `RPP_${subject}_${topic}.md`;
      a.click();
    }
  </script>
</body>
</html>
